/*!
 * ====================================================
 * Kity Formula Parser - v1.0.0 - 2014-07-31
 * https://github.com/HanCong03/kityformula-editor
 * GitHub: https://github.com/kitygraph/kityformula-editor.git 
 * Copyright (c) 2014 Baidu Kity Group; Licensed MIT
 * ====================================================
 */
;!function(){function e(b){d.r([f[b]])}var d={r:function(b){if(d[b].inited){return d[b].value}if("function"!=typeof d[b].value){return d[b].inited=!0,d[b].value}var i={exports:{}},h=d[b].value(null,i.exports,i);if(d[b].inited=!0,d[b].value=h,void 0!==h){return h}for(var g in i.exports){if(i.exports.hasOwnProperty(g)){return d[b].inited=!0,d[b].value=i.exports,i.exports}}}};d[0]={value:function(){function j(b){this.formula=b}function i(C,B,A,z,y){var x,w=null,v=null,u=[],t=B.operand||[],s=null;if(A.operand=[],-1===B.name.indexOf("text")){for(var h=0,c=t.length;c>h;h++){w=t[h],w!==k?w?"string"==typeof w?(t[h]="brackets"===B.name&&2>h?w:"function"===B.name&&0===h?w:p("text",w),A.operand.push(t[h])):(A.operand.push({}),t[h]=i(C.operand[h],w,A.operand[A.operand.length-1],z,y)):(t[h]=p("empty"),A.operand.push(t[h])):(u.push(h),y.hasOwnProperty("startOffset")||(y.startOffset=h),y.endOffset=h,B.attr&&B.attr.id&&(y.groupId=B.attr.id))}for(2===u.length&&(y.endOffset-=1);h=u.length;){h=u[h-1],t.splice(h,1),u.length--,C.operand.splice(h,1)}}if(s=o(B.name),!s){throw new Error("operator type error: not found "+B.operator)}x=function(){},x.prototype=s.prototype,v=new x,s.apply(v,t),A.func=v;for(var b in B.callFn){B.callFn.hasOwnProperty(b)&&v[b]&&v[b].apply(v,B.callFn[b])}return B.attr&&(B.attr.id&&(z[B.attr.id]={objGroup:v,strGroup:C}),B.attr["data-root"]&&(z.root={objGroup:v,strGroup:C}),v.setAttr(B.attr)),v}function p(g,c){switch(g){case"empty":return new kf.EmptyExpression;case"text":return new kf.TextExpression(c)}}function o(b){return l[b]||kf[b.replace(/^[a-z]/i,function(c){return c.toUpperCase()}).replace(/-([a-z])/gi,function(g,c){return c.toUpperCase()})+"Expression"]}function n(h){var g={};if("[object Array]"==={}.toString.call(h)){g=[];for(var s=0,r=h.length;r>s;s++){g[s]=m(h[s])}}else{for(var q in h){h.hasOwnProperty(q)&&(g[q]=m(h[q]))}}return g}function m(b){return b?"object"!=typeof b?b:n(b):b}var l={},k="\uf155";return j.prototype.generateBy=function(b){var s=b.tree,r={},q={},h={};if("string"==typeof s){throw new Error("Unhandled error")}return this.formula.appendExpression(i(s,n(s),r,h,q)),{select:q,parsedTree:s,tree:r,mapping:h}},j.prototype.regenerateBy=function(b){return this.formula.clearExpressions(),this.generateBy(b)},j}},d[1]={value:function(){return{toRPNExpression:d.r(2),generateTree:d.r(3)}}},d[2]={value:function(){function b(a){var i=[],c=null;for(a=h(a);c=a.shift();){"combination"===c.name&&1===c.operand.length&&"brackets"===c.operand[0].name&&(c=c.operand[0]),i.push(g.isArray(c)?b(c):c)}return i}function h(j){for(var i=[],l=null;void 0!==(l=j.pop());){if(!l||"object"!=typeof l||l.sign!==!1&&"function"!==l.name){i.push(l)}else{var k=l.handler(l,[],i.reverse());i.unshift(k),i.reverse()}}return i.reverse()}var g=d.r(4);return b}},d[3]={value:function(){function b(a){for(var k=null,j=[],i=0,c=a.length;c>i;i++){g.isArray(a[i])&&(a[i]=b(a[i]))}for(;k=a.shift();){j.push("object"==typeof k&&k.handler?k.handler(k,j,a):k)}return h(j)}var h=d.r(13),g=d.r(4);return b}},d[4]={value:function(){var b=d.r(7),i=d.r(6),h=d.r(15),g={getLatexType:function(a){return a=a.replace(/^\\/,""),b[a]?"operator":i[a]?"function":"text"},isArray:function(c){return c&&"[object Array]"===Object.prototype.toString.call(c)},getDefine:function(a){return g.extend({},b[a.replace("\\","")])},getFuncDefine:function(c){return{name:"function",params:c.replace(/^\\/,""),handler:h}},getBracketsDefine:function(a,j){return g.extend({params:[a,j]},b.brackets)},extend:function(k,j){for(var l in j){j.hasOwnProperty(l)&&(k[l]=j[l])}return k}};return g}},d[5]={value:function(){var b=!0;return{".":b,"{":b,"}":b,"[":b,"]":b,"(":b,")":b,"|":b}}},d[6]={value:function(){return{sin:1,cos:1,arccos:1,cosh:1,det:1,inf:1,limsup:1,Pr:1,tan:1,arcsin:1,cot:1,dim:1,ker:1,ln:1,sec:1,tanh:1,arctan:1,coth:1,exp:1,lg:1,log:1,arg:1,csc:1,gcd:1,lim:1,max:1,sinh:1,deg:1,hom:1,liminf:1,min:1,sup:1}}},d[7]={value:function(){var b=d.r(22),g=d.r(11);return{"^":{name:"superscript",type:g.OP,handler:b},_:{name:"subscript",type:g.OP,handler:b},frac:{name:"fraction",type:g.FN,sign:!1,handler:d.r(14)},sqrt:{name:"radical",type:g.FN,sign:!1,handler:d.r(23)},sum:{name:"summation",type:g.FN,traversal:"rtl",handler:d.r(24)},"int":{name:"integration",type:g.FN,traversal:"rtl",handler:d.r(16)},brackets:{name:"brackets",type:g.FN,handler:d.r(12)},mathcal:{name:"mathcal",type:g.FN,sign:!1,handler:d.r(19)},mathfrak:{name:"mathfrak",type:g.FN,sign:!1,handler:d.r(20)},mathbb:{name:"mathbb",type:g.FN,sign:!1,handler:d.r(18)},mathrm:{name:"mathrm",type:g.FN,sign:!1,handler:d.r(21)}}}},d[8]={value:function(){return{"int":d.r(26),quot:d.r(27)}}},d[9]={value:function(){return{combination:d.r(29),fraction:d.r(30),"function":d.r(31),integration:d.r(32),subscript:d.r(39),superscript:d.r(41),script:d.r(37),radical:d.r(38),summation:d.r(40),brackets:d.r(28),mathcal:d.r(34),mathfrak:d.r(35),mathbb:d.r(33),mathrm:d.r(36)}}},d[10]={value:function(){return{"#":1,$:1,"%":1,_:1,"&":1,"{":1,"}":1,"^":1,"~":1}}},d[11]={value:function(){return{OP:1,FN:2}}},d[12]={value:function(){var b=d.r(5);return function(a,j,i){for(var h=0,g=a.params.length;g>h;h++){if(!(a.params[h] in b)){throw new Error("Brackets: invalid params")}}return a.operand=a.params,a.params[2]=i.shift(),delete a.handler,delete a.params,a}}},d[13]={value:function(){return function(){return{name:"combination",operand:arguments[0]||[]}}}},d[14]={value:function(){return function(h,g,k){var j=k.shift(),i=k.shift();if(void 0===j||void 0===i){throw new Error("Frac: Syntax Error")}return j.handler&&"integration"===j.name?(j=j.handler(j,g,[i]),i=k.shift()):i.handler&&"integration"===i.name&&(i=i.handler(i,g,[k.shift()])),h.operand=[j,i],delete h.handler,h}}},d[15]={value:function(){var b=d.r(17);return function(a,i,h){var g=b.exec(h);return g.expr&&g.expr.handler&&"integration"===g.expr.name&&(g.expr=g.expr.handler(g.expr,i,[h.shift()])),a.operand=[a.params,g.expr,g.superscript,g.subscript],delete a.params,delete a.handler,a}}},d[16]={value:function(){var b=d.r(17),g=d.r(11).FN;return function(a,j,i){var h=i.shift(),c=b.exec(i);return c.expr&&c.expr.type===g&&c.expr.handler&&"integration"===c.expr.name&&(c.expr=c.expr.handler(c.expr,j,[i.shift()])),a.operand=[c.expr,c.superscript,c.subscript],a.callFn={setType:[0|h]},delete a.handler,a}}},d[17]={value:function(){function g(b){var j=c(b),i=null,h={superscript:null,subscript:null};if(!j){return h}if(i=c(b),h[j.type]=j.value||null,i){if(i.type===j.type){throw new Error("Script: syntax error!")}h[i.type]=i.value||null}return h}function c(i){var h=i.shift();return h?"subscript"===h.name||"superscript"===h.name?{type:h.name,value:i.shift()}:(i.unshift(h),null):null}return{exec:function(a){var i=g(a),h=a.shift();if(h&&h.name&&-1!==h.name.indexOf("script")){throw new Error("Script: syntax error!")}return i.expr=h||null,i}}}},d[18]={value:function(){return function(h,g,j){var i=j.shift();return"object"==typeof i&&"combination"===i.name&&(i=i.operand.join("")),h.name="text",h.attr={_reverse:"mathbb"},h.callFn={setFamily:["KF AMS BB"]},h.operand=[i],delete h.handler,h}}},d[19]={value:function(){return function(h,g,j){var i=j.shift();return"object"==typeof i&&"combination"===i.name&&(i=i.operand.join("")),h.name="text",h.attr={_reverse:"mathcal"},h.callFn={setFamily:["KF AMS CAL"]},h.operand=[i],delete h.handler,h}}},d[20]={value:function(){return function(h,g,j){var i=j.shift();return"object"==typeof i&&"combination"===i.name&&(i=i.operand.join("")),h.name="text",h.attr={_reverse:"mathfrak"},h.callFn={setFamily:["KF AMS FRAK"]},h.operand=[i],delete h.handler,h}}},d[21]={value:function(){return function(h,g,j){var i=j.shift();return"object"==typeof i&&"combination"===i.name&&(i=i.operand.join("")),h.name="text",h.attr={_reverse:"mathrm"},h.callFn={setFamily:["KF AMS ROMAN"]},h.operand=[i],delete h.handler,h}}},d[22]={value:function(){return function(h,g,k){var j=g.pop(),i=k.shift()||null;if(!i){throw new Error("Missing script")}if(j=j||"",j.name===h.name||"script"===j.name){throw new Error("script error")}return"subscript"===j.name?(j.name="script",j.operand[2]=j.operand[1],j.operand[1]=i,j):"superscript"===j.name?(j.name="script",j.operand[2]=i,j):(h.operand=[j,i],delete h.handler,h)}}},d[23]={value:function(){var b=d.r(13);return function(a,l,k){var j=k.shift(),i=null,h=null;if("["===j){for(j=[];(i=k.shift())&&"]"!==i;){j.push(i)}j=0===j.length?null:b(j),h=k.shift()}else{h=j,j=null}return a.operand=[h,j],delete a.handler,a}}},d[24]={value:function(){var b=d.r(17),g=d.r(11).FN;return function(a,i,h){var c=b.exec(h);return c.expr&&c.expr.type===g&&c.expr.handler&&"integration"===c.expr.name&&(c.expr=c.expr.handler(c.expr,i,[h.shift()])),a.operand=[c.expr,c.superscript,c.subscript],delete a.handler,a}}},d[25]={value:function(){function H(c){if(F(c)){return c.substring(1)}switch(w.getLatexType(c)){case"operator":return w.getDefine(c);case"function":return w.getFuncDefine(c);default:return G(c)}}function G(c){return 0===c.indexOf("\\")?c+"\\":c}function F(c){return 0===c.indexOf("\\")?!!x[c.substring(1)]:!1}function E(c){return c.replace(/\\\s+/,"").replace(/\s*([^a-z0-9\s])\s*/gi,function(h,g){return g})}var D=d.r(43).Parser,C=d.r(1),B=d.r(8),A=d.r(42),z=d.r(7),y=d.r(9),x=d.r(10),w=d.r(4),v="\ufff8",u="\ufffc",t=new RegExp(v+"|"+u,"g"),s=new RegExp(v,"g"),b=new RegExp(u,"g");D.register("latex",D.implement({parse:function(g){var c=this.split(this.format(g));return c=this.parseToGroup(c),c=this.parseToStruct(c),this.generateTree(c)},serialization:function(g,c){return A(g,c)},expand:function(h){var g=h.parse,l=null,k=h.pre,j=h.reverse;for(var i in g){g.hasOwnProperty(i)&&(l=i.replace(/\\/g,""),z[l]=g[i])}for(var i in j){j.hasOwnProperty(i)&&(y[i.replace(/\\/g,"")]=j[i])}if(k){for(var i in k){k.hasOwnProperty(i)&&(B[i.replace(/\\/g,"")]=k[i])}}},format:function(g){g=E(g),g=g.replace(t,"").replace(/\\{/gi,v).replace(/\\}/gi,u);for(var c in B){B.hasOwnProperty(c)&&(g=B[c](g))}return g},split:function(h){var g=[],k=/(?:\\[^a-z]\s*)|(?:\\[a-z]+\s*)|(?:[{}]\s*)|(?:[^\\{}]\s*)/gi,j=/^\s+|\s+$/g,i=null;for(h=h.replace(j,"");i=k.exec(h);){i=i[0].replace(j,""),i&&g.push(i)}return g},generateTree:function(h){for(var g=[],i=null;i=h.shift();){g.push(w.isArray(i)?this.generateTree(i):i)}return g=C.toRPNExpression(g),C.generateTree(g)},parseToGroup:function(i){for(var h=[],n=[h],m=0,l=0,k=0,j=i.length;j>k;k++){switch(i[k]){case"{":m++,n.push(h),h.push([]),h=h[h.length-1];break;case"}":m--,h=n.pop();break;case"\\left":l++,n.push(h),h.push([[]]),h=h[h.length-1][0],h.type="brackets",k++,h.leftBrackets=i[k].replace(s,"{").replace(b,"}");break;case"\\right":l--,k++,h.rightBrackets=i[k].replace(s,"{").replace(b,"}"),h=n.pop();break;default:h.push(i[k].replace(s,"\\{").replace(b,"\\}"))}}if(0!==m){throw new Error("Group Error!")}if(0!==l){throw new Error("Brackets Error!")}return n[0]},parseToStruct:function(a){for(var i=[],h=0,g=a.length;g>h;h++){w.isArray(a[h])?"brackets"===a[h].type?(i.push(w.getBracketsDefine(a[h].leftBrackets,a[h].rightBrackets)),i.push(this.parseToStruct(a[h]))):i.push(this.parseToStruct(a[h])):i.push(H(a[h]))}return i}}))}},d[26]={value:function(){return function(b){return b.replace(/\\(i+)nt(\b|[^a-zA-Z])/g,function(h,g,i){return"\\int "+g.length+i})}}},d[27]={value:function(){return function(b){return b.replace(/``/g,"\u201c")}}},d[28]={value:function(){return function(b){return("{"===b[0]||"}"===b[0])&&(b[0]="\\"+b[0]),("{"===b[1]||"}"===b[1])&&(b[1]="\\"+b[1]),["\\left",b[0],b[2],"\\right",b[1]].join(" ")}}},d[29]={value:function(){return function(b){return this.attr["data-root"]||this.attr["data-placeholder"]?b.join(""):"{"+b.join("")+"}"}}},d[30]={value:function(){return function(b){return"\\frac "+b[0]+" "+b[1]}}},d[31]={value:function(){return function(g){var c=["\\"+g[0]];return g[2]&&c.push("^"+g[2]),g[3]&&c.push("_"+g[3]),g[1]&&c.push(" "+g[1]),c.join("")}}},d[32]={value:function(){return function(h){var g=["\\int "];if(this.callFn&&this.callFn.setType){g=["\\"];for(var j=0,i=this.callFn.setType;i>j;j++){g.push("i")}g.push("nt ")}return h[1]&&g.push("^"+h[1]),h[2]&&g.push("_"+h[2]),h[0]&&g.push(" "+h[0]),g.join("")}}},d[33]={value:function(){return function(b){return"\\mathbb{"+b[0]+"}"}}},d[34]={value:function(){return function(b){return"\\mathcal{"+b[0]+"}"}}},d[35]={value:function(){return function(b){return"\\mathfrak{"+b[0]+"}"}}},d[36]={value:function(){return function(b){return"\\mathrm{"+b[0]+"}"}}},d[37]={value:function(){return function(b){return b[0]+"^"+b[1]+"_"+b[2]}}},d[38]={value:function(){return function(g){var c=["\\sqrt"];return g[1]&&c.push("["+g[1]+"]"),c.push(" "+g[0]),c.join("")}}},d[39]={value:function(){return function(b){return b[0]+"_"+b[1]}}},d[40]={value:function(){return function(g){var c=["\\sum "];return g[1]&&c.push("^"+g[1]),g[2]&&c.push("_"+g[2]),g[0]&&c.push(" "+g[0]),c.join("")}}},d[41]={value:function(){return function(b){return b[0]+"^"+b[1]}}},d[42]={value:function(){function b(a,p){var o=[],n=null,m=null;if("object"!=typeof a){return j(a)?"\\"+a+" ":a.replace(g,function(q,k){return k+" "})}"combination"===a.name&&1===a.operand.length&&"combination"===a.operand[0].name&&(a=a.operand[0]),m=a.operand;for(var l=0,c=m.length;c>l;l++){o.push(m[l]?b(m[l]):m[l])}return n=a.attr&&a.attr._reverse?a.attr._reverse:a.name,i[n].call(a,o,p)}function j(c){return !!h[c]}var i=d.r(9),h=d.r(10),g=/(\\(?:[\w]+)|(?:[^a-z]))\\/gi;return function(a,k){return b(a,k)}}},d[43]={value:function(r,q,p){function o(b){this.impl=new b,this.conf={}}function n(){this.conf={}}var m={},l={},k={extend:function(h,g){var u=null;g=[].slice.call(arguments,1);for(var t=0,s=g.length;s>t;t++){u=g[t];for(var i in u){u.hasOwnProperty(i)&&(h[i]=u[i])}}},setData:function(h,g,i){if("string"==typeof g){h[g]=i}else{if("object"!=typeof g){throw new Error("invalid option")}for(i in g){g.hasOwnProperty(i)&&(h[i]=g[i])}}}},j={use:function(b){if(!l[b]){throw new Error("unknown parser type")}return this.proxy(l[b])},config:function(g,c){return k.setData(m,g,c),this},register:function(g,c){return l[g.toLowerCase()]=c,this},implement:function(h){var g=function(){},t=h.constructor||function(){},s=function(){n.call(this),t.call(this)};g.prototype=n.prototype,s.prototype=new g,delete h.constructor;for(var i in h){"constructor"!==i&&h.hasOwnProperty(i)&&(s.prototype[i]=h[i])}return s},proxy:function(b){return new o(b)}};k.extend(o.prototype,{config:function(g,c){k.setData(this.conf,g,c)},set:function(g,c){this.impl.set(g,c)},parse:function(g){var c={config:{},tree:this.impl.parse(g)};return k.extend(c.config,m,this.conf),c},serialization:function(g,c){return this.impl.serialization(g,c)},expand:function(b){this.impl.expand(b)}}),k.extend(n.prototype,{set:function(g,c){k.extend(this.conf,g,c)},parse:function(){throw new Error("Abstract function")}}),p.exports={Parser:j,ParserInterface:n}}},d[44]={value:function(){var b=d.r(43).Parser;d.r(25),window.kf.Parser=b,window.kf.Assembly=d.r(0)}};var f={"kf.start":44};!function(){try{e("kf.start")}catch(a){}}(this)}();