(function(){var B={start:function(c){r=c;window.kfEditor=r;s=d(r);f=document.getElementById("hiddenInput");m()}},o=false,f=null,j=false,s=null,y=-1,u=-1,x=-1,z=null,D=null,l=-1,q=null,i=null,e=null,A=false,b=false,t={x:0,y:0},k=1000,w=0,C=null,p=10,r=null;function m(){var L=r.request("ui.canvas.container.event");L.on("mousedown",function(U){U.preventDefault();if(U.which!==1){return}b=true;A=false;t={x:U.clientX,y:U.clientY};M();u=0;var T=U.target,S=r.requestService("position.get.group",T),R=r.requestService("position.get.parent.group",T);if(!S){S=r.requestService("syntax.get.group.content","_kf_editor_1_1")}if(!R){R=S}e=S;z=S;q=z;x=E(z,U.clientX);i=x;if(S){r.requestService("render.select.group.content",S);r.requestService("syntax.update.record.cursor",S.id,x);var Q=r.requestService("syntax.get.record.cursor");var P=r.requestService("syntax.get.latex.info");J(P);if(Q.startOffset===Q.endOffset){if(r.requestService("syntax.valid.placeholder",R.id)){r.requestService("render.select.group",R.id)}else{I(S,Q.startOffset)}}}else{r.requestService("render.clear.select")}});L.on("dblclick",function(S){S.preventDefault();b=false;A=false;M();var R=S.target,Q=r.requestService("position.get.parent.group",R);if(Q){r.requestService("render.select.group.all",Q);var P=r.requestService("syntax.update.selection",Q);J(P)}else{r.requestService("render.clear.select")}});L.on("mouseup",function(Q){Q.preventDefault();var R=A;A=false;b=false;if(R){var P=r.requestService("syntax.get.latex.info");J(P)}});f.addEventListener("keydown",function(P){b=false;A=false;M();switch(P.keyCode){case 37:P.preventDefault();r.requestService("syntax.cursor.move.left");H();return;case 39:P.preventDefault();r.requestService("syntax.cursor.move.right");H();return}},false);r.registerService("control.insert.group",null,{insertGroup:G});function G(T){var S=f.value,P=f.selectionStart,Q=f.selectionEnd,R=null;r.requestService("syntax.insert.group",T);R=r.requestService("syntax.get.latex.info");J(R);r.requestService("render.draw",R.str);K()}function H(){var Q=r.requestService("syntax.get.record.cursor"),R=r.requestService("syntax.get.group.content",Q.groupId);r.requestService("render.select.group.content",R);var P=r.requestService("syntax.get.latex.info");J(P);if(Q.startOffset===Q.endOffset&&!r.requestService("syntax.valid.placeholder",Q.groupId)){I(R,Q.startOffset)}return P}function N(P){r.requestService("render.reselect");J(P);K()}L.on("mousemove",function(Q){var P=null;Q.preventDefault();if(b&&!A&&(Math.abs(Q.clientX-t.x)>p||Math.abs(Q.clientY-t.y)>p)){A=true}if(!A){return}M();var P=r.requestService("position.get.group",Q.target);if(!P){P=r.requestService("syntax.get.group.content","_kf_editor_1_1")}D=r.requestService("syntax.get.group.content",P.id);l=c(D,Q.clientX);r.requestService("syntax.update.record.cursor",D.id,x,l);r.requestService("render.select.current.cursor");if(x===l){if(r.requestService("syntax.valid.placeholder",P.id)){r.requestService("render.select.group",P.id)}else{I(D,l)}}});f.oninput=function(P){u+=f.value.length-y;r.requestService("render.draw",f.value);r.requestService("render.reselect");K()};function K(){var P=r.requestService("syntax.get.record.cursor"),Q=r.requestService("syntax.get.group.content",P.groupId);I(Q,P.startOffset);r.requestService("render.select.group",P.groupId)}function J(P){f.value=P.str;f.selectionStart=P.startOffset;f.selectionEnd=P.endOffset;f.focus();j=true}f.onblur=function(){j=false;M()};function F(R,T,U){var P=null,Q=null,S=false,V=null;if(R.groupObj.contains(T.groupObj)){S=true;P=R;V=T}else{if(T.groupObj.contains(R.groupObj)){P=T;V=R}else{P=T;v();while(P=r.requestService("position.get.group",P.groupObj)){h();if(P.groupObj.contains(R.groupObj)){break}}V=R}}Q=V;v();while(V=r.requestService("position.get.parent.group",V.groupObj)){h();if(V.id===P.id){V=Q;break}Q=V}z=P;D=P;if(S){x=i;l=P.content.indexOf(V.groupObj);if(l>=x){l+=1}}else{x=P.content.indexOf(V.groupObj);l=O(P,U);if(U<t.x){x+=1}else{l+=1}}}function E(R,S){var P=O(R,S),T=-1,Q=null;Q=R.content[P].getBoundingClientRect();T=S-Q.left;if(T>Q.width/2){P+=1}return P}function O(R,S){var P=-1,Q=null;kity.Utils.each(R.content,function(U,T){P=T;Q=U.getBoundingClientRect();if(Q.left+Q.width>S){return false}});return P}function c(R,S){z=q;x=i;if(q.id!==R.id){F(q,R,S);return l}var P=-1,Q=null,T=-1;kity.Utils.each(R.content,function(V,U){P=U;Q=V.getBoundingClientRect();if(Q.left+Q.width>S){return false}});Q=R.content[P].getBoundingClientRect();T=S-Q.left;if(P>=i){if(T>Q.width/3){P+=1}}else{if(T>Q.width/3*2){P+=1}}return P}function M(){o=false;g();s.node.style.display="none"}function I(Z,W){var X=null,U=true,Y=null,V=null,Q=null;if(!j){return}var R=r.requestService("render.get.paper"),T=R.getViewPort().offset,S=0,aa=r.requestService("render.get.canvas.zoom"),P=R.getZoom();if(W===Z.content.length){W-=1;U=false}X=Z.content[W];V=X.getBoundingClientRect();Y=Z.content[W-1]||X;Y=Y.getBoundingClientRect();Q=s.getTransform();if(U){S=V.left-R.container.node.getBoundingClientRect().left}else{S=V.left-R.container.node.getBoundingClientRect().left+V.width}Q.m.e=S/aa/P;Q.m.f=(Y.top-R.container.node.getBoundingClientRect().top)/aa/P;s.setHeight(Y.height/aa/P);s.setTransform(Q);s.node.style.display="block";o=true;a()}}function v(){w=0}function h(){w++;if(w>k){throw new Error("stack overflow")}}function d(c){var E=c.execCommand("getPaper"),F=new kity.Rect(1,27,0,0).fill("black");F.node.style.display="none";E.addShape(F);return F}function a(){if(C){window.clearInterval(C)}C=window.setInterval(n,800)}function g(){window.clearInterval(C)}function n(){s.node.style.display=o?"none":"block";o=!o}window.c=B})();